# ğŸŠ TECHNICAL ASSESSMENT - COMPLETE IMPLEMENTATION

## âœ… PROJECT STATUS: COMPLETE & PRODUCTION READY

---

## ğŸ“‹ What Has Been Delivered

### **TASK 1: Data Management & APIs** âœ… COMPLETE

#### 1.1 File Upload API (CSV/XLSX with Worker Threads) âœ…
- **Endpoint:** `POST /api/upload`
- **Features:**
  - Accepts CSV/XLSX files via multipart/form-data
  - Uses Node.js worker threads for CPU-efficient processing
  - Prevents main thread blocking
  - Parses CSV and extracts structured data
  - Creates 6 MongoDB collections automatically
  - Returns import summary with counts
- **Location:** `src/services/FileUploadService.js` + `src/workers/csvProcessor.js`

#### 1.2 Policy Search API (by Username) âœ…
- **Endpoint:** `GET /api/policies/search?username=<firstname>`
- **Features:**
  - Case-insensitive search by user firstname
  - Returns user details and all associated policies
  - Populates carrier and LOB information
  - Returns total policy count
- **Location:** `src/services/PolicyService.js`

#### 1.3 Aggregated Policy API âœ…
- **Endpoint:** `GET /api/policies/aggregated`
- **Features:**
  - MongoDB aggregation pipeline for grouping
  - Groups all policies by user
  - Calculates total policies per user
  - Sums total premium per user
  - Sorted by premium (highest first)
- **Location:** `src/services/PolicyService.js`

#### 1.4 Six MongoDB Collections âœ…
- **Agent** - Agent information
- **User** - Policy holders with personal details
- **UserAccount** - Customer accounts linked to users
- **LOB** - Insurance categories (Commercial Auto, Homeowners, etc.)
- **Carrier** - Insurance companies
- **Policy** - Insurance policies with references
- **ScheduledMessage** - Scheduled messages (Bonus)
- **Location:** `src/models/*.js` (7 schema files)

---

### **TASK 2: System Management & Services** âœ… COMPLETE

#### 2.1 CPU Monitoring & Server Restart âœ…
- **Threshold:** 70% CPU usage
- **Check Interval:** Every 5 seconds
- **Features:**
  - Real-time CPU usage monitoring
  - Logs current CPU percentage
  - Triggers graceful shutdown at 70% threshold
  - 10-second warning before restart
  - Logs in real-time as CPU changes
- **Location:** `src/services/CPUMonitorService.js`
- **Integration:** `src/server.js`

#### 2.2 Scheduled Message Service âœ…
- **Endpoint:** `POST /api/messages/schedule`
- **Features:**
  - Schedule messages for specific day and time
  - Accepts day name (Monday, Tuesday, etc.) and time (HH:MM)
  - Calculates next occurrence of scheduled date/time
  - Stores in MongoDB ScheduledMessage collection
  - Background processor runs every 60 seconds
  - Automatically marks messages as sent when time arrives
  - Persistent across server restarts
- **Location:** `src/services/ScheduledMessageService.js`

---

## ğŸ“ Project Structure

```
server/                            [Main application]
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ models/                    [7 MongoDB schemas]
    â”‚   â”œâ”€â”€ routes/                    [3 API route handlers]
    â”‚   â”œâ”€â”€ services/                  [4 business logic services]
    â”‚   â”œâ”€â”€ workers/                   [Worker thread for CSV]
    â”‚   â”œâ”€â”€ middleware/                [Database connection]
    â”‚   â””â”€â”€ server.js                  [Main Express app]
    â”‚
    â”œâ”€â”€ uploads/                       [Uploaded files]
    â”œâ”€â”€ package.json                   [Dependencies]
    â”œâ”€â”€ .env                           [Configuration]
    â”œâ”€â”€ README.md                      [Full API documentation]
    â”œâ”€â”€ QUICKSTART.md                  [3-step setup guide]

## ğŸš€ Quick Start (3 Steps)

### Step 1: Install Dependencies
```bash

npm install
```

### Step 2: Start MongoDB
```bash
mongod
```

### Step 3: Run Server
```bash
npm start
```

**Output:**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   Insurance API Server                    â•‘
â•‘   Running on http://localhost:5000        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ§ª Test the APIs

### Test 1: Upload Your Data
```bash
cd d:\InsuredMine
curl -X POST -F "file=@data-sheet - Node js Assesment (2) (1).csv" \
  http://localhost:5000/api/upload
```

### Test 2: Search Policies
```bash
curl "http://localhost:5000/api/policies/search?username=Lura"
```

### Test 3: Get Aggregated Data
```bash
curl http://localhost:5000/api/policies/aggregated
```

### Test 4: Schedule a Message
```bash
curl -X POST http://localhost:5000/api/messages/schedule \
  -H "Content-Type: application/json" \
  -d '{"message":"Renewal reminder","day":"Monday","time":"10:00"}'
```

---

## ğŸ“Š Key Implementation Details

### Worker Threads
- Parses CSV in separate thread (non-blocking)
- Main event loop remains responsive
- Efficient memory management
- Handles large files without freezing

### MongoDB Collections
```
Agent â†â”€â†’ User â†â”€â†’ UserAccount
              â†“
            Policy â†â”€â†’ Carrier (company)
              â†“
              LOB (category)
```

### CPU Monitoring
- Checks every 5 seconds
- Calculates CPU usage using `os.cpus()`
- If CPU â‰¥ 70%: Logs warning, initiates graceful shutdown
- Clean shutdown with resource cleanup

### Scheduled Messages
- Background processor runs every 60 seconds
- Checks for messages with `scheduled_date <= now`
- Marks as sent and updates `sent_at` timestamp
- Persists in MongoDB for reliability

---
